<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<title>FeatureLayer</title>

<link rel="stylesheet" href="https://js.arcgis.com/3.20/esri/css/esri.css">
<script src="https://js.arcgis.com/3.20/"></script>

<style>
html, body, #map {
  padding: 0;
  margin: 0;
  height: 100%;
  width: 100%;
}
</style>

<script>
  var teamNumber = 0;
  var geofenceRadius = 2;
  var activate = true;

  require([
      "esri/map",
      "esri/layers/FeatureLayer",
      "esri/geometry/Circle",
      "esri/graphic",
      "esri/arcgis/utils",
      "esri/request",
      "dojo/domReady!"
    ],
    function(
      Map,
      FeatureLayer,
      Circle,
      Graphic,
      arcgisUtils,
      esriRequest
    ) {
      teamNumber = getURLParamfromUrl('team');
      geofenceRadius = getURLParamfromUrl('radius') || 2;

      arcgisUtils.createMap("833eef7f42d84159885967f50a9eca7c", "map").then(function (response) {
        var map = response.map;
        map.hideZoomSlider();
        map.disableDoubleClickZoom();
        map.disableRubberBandZoom();
        map.disableScrollWheelZoom();
        map.disableShiftDoubleClickZoom();
        addGeofence(map);
      });

      function addGeofence(map) {
        var featureLayer = new FeatureLayer("https://services.arcgis.com/wlVTGRSYTzAbjjiC/arcgis/rest/services/geofence_devsession2017/FeatureServer/0");
        map.addLayer(featureLayer);
        
        map.on("click", function(evt) {
          if (activate === true) {
            activate = false;
            
            var geom = new Circle(evt.mapPoint,{
              "radius": geofenceRadius
            });
            var attr = { "teamname": "gcf-2017-" + teamNumber }; // gcf-2017-1 | gcf-2017-2 | gcf-2017-3
            var graphic = new Graphic(geom, null, attr);
            featureLayer.applyEdits([graphic], null, null, function (res) {
              console.log(res);
              setTimeout(function () {
                graphic.attr("OBJECTID", res.objectId);
                featureLayer.applyEdits(null, null, [graphic]);
                activate = true;
              }, 3000);
            });
          }
        });
      }

      function getURLParamfromUrl(paramText) {
        var number = 0;
        var urlParams = location.hash.substring(1).split('&');
        for (var i=0; urlParams[i]; i++) {
          var param = urlParams[i].split('=');
          if (param[0] === paramText) {
             number = param[1];
          }
        }
        return number;
      }

  });
</script>
</head>

<body>
  <div id="map"></div>
</body>

</html>
